<!DOCTYPE html>

{% if r_lang == "ja" %}
<html lang="ja">
{% else %}
<html lang="en">
{% endif %}

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>PubcaseFinder</title>
	<!--css-->
	<link rel='stylesheet' href="/static/css/pcf/bootstrap.css">
	<link rel="stylesheet" href="https://unpkg.com/destyle.css@1.0.5/destyle.css">
	<link rel='stylesheet' href="/static/css/pcf/branc.css">
	<link rel='stylesheet' href="/static/css/pcf/branc-ie7.css">
	<link rel='stylesheet' href="/static/css/pcf/branc-ie7-codes.css">
	<link rel='stylesheet' href="/static/css/pcf/branc-embedded.css">
	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link rel="stylesheet" href="/static/css/pcf/style.css">
	<link rel="stylesheet" href="/static/css/pcf/mobile.css">
	<link
		href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=Noto+Sans+JP:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

	<!-- <link rel="stylesheet" href="/static/css/animate.css"> -->
	<!-- <link rel="stylesheet" href="/static/css/icomoon.css"> --> 

	<link rel="stylesheet" href="/static/css/pcf/magnific-popup.css">
	<link rel="stylesheet" href="/static/css/pcf/token-input-facebook.css">
	<link rel="stylesheet" href="/static/css/pcf/popup-hierarchy-hpo.css">
	<link rel="stylesheet" href="/static/css/pcf/popup-hierarchy-gene.css">

	<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/animations/scale.css" />
	
	<link rel="icon" href="/static/images/favicon.ico">

	<!-- favicon for mobile -->
	<link rel="apple-touch-icon" sizes="180x180" href="/static/images/apple-touch-icon.png">

	<!--schema.rog-->
	<script type="application/ld+json">
	  {
	  "@context": "http://schema.org/",
	  "@type": "Dataset",
	  "name": "PubCaseFinder",
	  "description": "PubCaseFinder (PCF) is a rare and genetic disease search system, always up-to-date",
	  "url": "https://pubcasefinder.dbcls.jp/",
	  "version": "1.0",
	  "keywords": "PubCaseFinder,PCF,Rare Disease,Phenotype,Gene,Match,Assist",
	  "creator": "Database Center for Life Science, DBCLS",
	  "license": "http://creativecommons.org/licenses/by/2.1/jp/",
	  "distribution": {
		"contentUrl": "http://togodb.org/db/disease_phenotype_associations_20170720",
		"fileFormat": "csv"
		}
	  }
	</script>
</head>

<body>
	<!-- <div id="fh5co-loader" style="display:none;"></div> -->
	<div id="fh5co-loader"></div>
	<header class="search-header">
		<div class="wrapper search-header_wrapper">
			<div class="search-header_top">
				<div class="brand">
					<a href="/" class="brand"><img src="/static/images/pcf/logo_color.svg" alt=""></a>
				</div>
				<div class="search-header_left">
					<span><a id="link_en" href="/result?target={{ r_target }}&phenotype={{ r_phenotype }}&filter={{ r_filter }}&size={{ r_size }}&display_format={{ r_display_format }}&lang=en">EN</a> / <a id="link_ja" href="/result?target={{ r_target }}&phenotype={{ r_phenotype }}&filter={{ r_filter }}&size={{ r_size }}&display_format={{ r_display_format }}&lang=ja">JA</a>
					</span>
					<nav class="nav">
						<ul>
							<li class="menu-item-has-children">
								<a href="#"><span class="material-icons">menu</span></a>
								<ul class="sub-menu">
									<li><a href="#">About</a></li>
									<li><a href="#">Datasets</a></li>
									<li><a href="#">History</a></li>
									<li><a href="#">Terms</a></li>
									<li><a href="#">RDF</a></li>
									<li><a href="#">API</a></li>
									<li><a href="#">Contect</a></li>
								</ul>
							</li>
						</ul>
					</nav>
					<div class="site-header_end">
						<a class="button" href="#">Login<i class="material-icons">expand_more</i></a>
					</div>
				</div>
			</div>
			<div class="search-box_wrapper">
				<div class="search-box_form d-flex flex-nowrap">
					<div class="d-flex flex-column">
						<div class=""  style="height:50%;" id="text2hpo">
							{% if r_lang == "ja" %}
							<button id="/text2hpo"
							{% else %}
							<button id="https://impact.dbmi.columbia.edu/doc2hpo/"
							{% endif %}
							   onclick="goDoc(this);"
							   class="text-button"
							   data-toggle="tooltip"
							   data-placement="top"
							{% if r_lang == "ja" %}
							   title="文章から症状を自動抽出">
							{% else %}
							   title="Input Free-Text (doc2hpo)">
							{% endif %}
							  <img src="/static/images/pcf/text_black.svg"></img>
							</button>
						</div>
						<div class=""  style="height:50%;">
							<button id="phenotouch"
							    class="phenotouch-button"
							    data-toggle="tooltip"
							    data-placement="top"
							{% if r_lang == "ja" %}
							    title="ヒト3Dモデルを利用して症状を検索">
							{% else %}
							    title="Find Phenotypes using Human 3D Model">
							{% endif %}
							    <img src="/static/images/pcf/3d_black.svg"></img>
							</button>
						</div>
					</div>
					<div class="flex-grow-1 tokeninput_hpo_wrapper">
						<textarea rows="1" id="tokeninput_hpo" name="str_phenotypes"></textarea>
					</div>
					<div class="d-flex flex-column">
						<div class="" style="height:50%;"><button id="tokeninput_hpo_clear" class="round-button material-icons">clear</button></div>
						<div class="" style="height:50%;">
							<button id="search_button" style="color:white;background-color:#f8516d;opacity=1.0;border:0;" class="round-button material-icons">search</button>
						</div>
					</div>
				</div>
				<div class="search-button" id="div_search_button">
					<!-- advanced button -->
					<button id="btn_search_advanced" data-toggle="collapse" data-target="#search-box-advanced" aria-expanded="false" aria-controls="search-box-advanced">
						Filter<i class="material-icons">expand_more</i>
					</button>

					<!-- download button -->
					<div class="dropdown" id="search-button_download-wrapper">
						<button id="search-button_download" class="dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
							{% if r_lang == "ja" %}
							<span class="material-icons" data-toggle="tooltip" data-placement="top" title="ダウンロード">save_alt</span>
							{% else %}
							<span class="material-icons" data-toggle="tooltip" data-placement="top" title="Download">save_alt</span>
							{% endif %}
						</button>
						<div class="dropdown-menu" aria-labelledby="search-button_download">
						<form class="px-4 py-3" id="download-form">
							<label><b>{{ _('search_share_modal_label_download') }}</b></label>
							<table>
								<tr>
									<td style="vertical-align: middle;">Target:</td>
									<td id="str_target">
									   {% if r_target == "omim" %}
									 Genetic Disease
									   {% elif r_target == "orphanet" %}
									 Rare Disease
									   {% elif r_target == "gene" %}
									 Gene
									   {% elif r_target == "case" %}
									 Case
									   {% else %}
									 Genetic Disease
									   {% endif %}
									</td>
								</tr>
								<tr>
									<td style="vertical-align: middle;padding-left:0;padding-right:10px;">Selection:</td>
									<td>
									  <select style="width:200px;" class="form-control custom-select" id="sel_download_option">
										 <option value="all_shown">All displayed results</option>
										 <option value="all">All results</option>
										 <option value="sel">Selection (n)</option>
									  </select>
									</td>
								</tr>
								<tr>
									<td style="vertical-align: middle;padding-left:0;padding-right:10px;">Format:</td>
									<td>
									  <select style="width:200px;" class="form-control custom-select" id="sel_download_format">
										 <option value="tsv">TSV</option>
										 <option value="json">JSON</option>
									  </select>
									</td>
								</tr>
							</table>
							<div class="btn-toolbar" style="margin-top:10px;">
							  <button class="action-button" id="btn_download">Download</button>
							</div>
						</form>
						</div>
					</div>

					<!-- share button -->
					<div class="dropdown" id="search-button_share-wrapper">
						<button class="dropdown-toggle" id="search-button_share" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
							{% if r_lang == "ja" %}
							<span class="material-icons" data-toggle="tooltip" data-placement="top" title="共有">share</span>
							{% else %}
							<span class="material-icons" data-toggle="tooltip" data-placement="top" title="Share">share</span>
							{% endif %}
						</button>
						<div class="dropdown-menu" aria-labelledby="search-button_share">
						<form class="px-4 py-3">
						<label><b>{{ _('search_share_modal_label_link') }}</b></label>
							<table>
								<tr>
									<td style="vertical-align: middle;">
										<input style="width:340px;" type="text" id="share_link" value="https://pcf.dbcls.jp/result?target={{ r_target }}&phenotype={{ r_phenotype }}&filter={{ r_filter }}&size={{ r_size }}&display_format={{ r_display_format }}&lang={{ r_lang }}" readonly>
									</td>
						  		</tr>
							</table>
							<div class="btn-toolbar" style="margin-top:10px;">
								<button class="action-button" id="btn_copy_link">Copy Link</button>
								<button class="action-button" id="btn_email_link">E-mail</button>
							</div>
						</form>
						</div>
					</div>

					<!-- display button -->
					<div class="dropdown" id="search-button_display-wrapper">
						<button class="dropdown-toggle" type="button" id="search-button_display" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
							Display options<i class="material-icons">expand_more</i>
						</button>
						<div class="dropdown-menu dropdown-menu-right" aria-labelledby="search-button_display">
							<form class="px-4 py-3">
								<label>
									{% if r_lang == "ja" %}
									<b>表示オプション</b>
									{% else %}
									<b>Display options</b>
									{% endif %}
								</label>
								<table>
									<tr>
										<td style="vertical-align: middle;padding-left:0;padding-right:10px;">Format:</td>
										<td>
											<!-- <select style="width:150px;" class="form-control custom-select" id="str_display_format"> -->
											<!-- <select style="width:150px;" class="custom-select" id="str_display_format"> -->
											<select style="width:150px;" class="custom-select" id="str_display_format" onchange="str_display_format_onchange(this.value);">
												<option value="summary" {% if r_display_format == "summary" %} selected {% endif %}>Summary</option>
												<option value="full" {% if r_display_format == "full" %} selected {% endif %}>Full</option>
									  		</select>
										</td>
									</tr>
									<tr>
										<td style="vertical-align: middle; padding-right:10px;" nowrap>Per page:</td>
										<td>
											<!-- <select style="width:150px;" class="form-control custom-select" id="str_size"> -->
											<!-- <select style="width:150px;" class="custom-select" id="str_size"> -->
											<select style="width:150px;" class="custom-select" id="str_size" onchange="str_size_onchange(this.value);">
												<option value=10  {% if r_size == "10" %} selected {% endif %}>10</option>
												<option value=20  {% if r_size == "20" %} selected {% endif %}>20</option>
												<option value=50  {% if r_size == "50" %} selected {% endif %}>50</option>
												<option value=100 {% if r_size == "100" %} selected {% endif %}>100</option>
												<option value=200 {% if r_size == "200" %} selected {% endif %}>200</option>
											</select>
										</td>
									</tr>
								</table>
							</form>
						</div>
					</div>
				</div>
			</div>

			<div class="search-advanced collapse" id="search-box-advanced">
				<div class="search-box-advanced_wrapper">
					<span><b>{{ _('search_textbox_title_narrowdown') }}</b></span>
					<textarea class="form-control" rows="1" id="tokeninput_genes" name="str_filters"></textarea>
				</div>
			</div>
		</div>
	</header>
{% if r_lang == "ja" %}
	<input type=hidden id="r_lang" value="ja" />
{% else %}
	<input type=hidden id="r_lang" value="en" />
{% endif %}
	<section class="content-wrapper">
		<div class="content-panel" id="pcf-content"></div>
		<div class='credit'></div>
	</section>

<div id="popover_html_phenotype" style="display:none;">
	<table>
		<tr><th class="popup_content_class">HPO ID	</th><td><a href="popup_content_hpo_url" target="_blank">popup_content_pcf-phenotype-id</td></tr>

{% if r_lang == "en" %}
		<tr><th class="popup_content_class">Label</th><td>popup_content_name_en</td></tr>
{% else %}
		<tr><th class="popup_content_class">Label(ja) </th><td>popup_content_name_ja</td></tr>
		<tr><th class="popup_content_class">Label(en) </th><td>popup_content_name_en</td></tr>
{% endif %}

		<tr><th class="popup_content_class">Definition</th><td>popup_content_definition</td></tr>
		<tr><th class="popup_content_class">Comment   </th><td>popup_content_comment</td></tr>
		<tr><th class="popup_content_class">Synonym   </th><td>popup_content_synonym</td></tr>
	</table>
</div>

<div id="popover_html_disease" style="display:none;">
	<table>
		<tr><th class="popup_content_class">MONDO ID  </th><td><a href="popup_content_mondo_url" target="_blank">popup_content_pcf-disease-id</td></tr>
{% if r_lang == "en" %}
		<tr><th class="popup_content_class">Label     </th><td>popup_content_name_en</td></tr>
{% else %}
		<tr><th class="popup_content_class">Label(ja) </th><td>popup_content_name_ja</td></tr>
		<tr><th class="popup_content_class">Label(en) </th><td>popup_content_name_en</td></tr>
{% endif %}
		<tr><th class="popup_content_class">Definition</th><td>popup_content_definition</td></tr>
		<tr><th class="popup_content_class">Synonym   </th><td>popup_content_synonym</td></tr>
		<tr><th class="popup_content_class">OMIM	  </th><td>popup_content_omim_list</td></tr>
		<tr><th class="popup_content_class">Orphanet  </th><td>popup_content_orpha_list</td></tr>
	</table>
</div>

<div id="popover_html_gene" style="display:none;">
	<table>
		<tr><th class="popup_content_class">NCBI Gene ID</th><td><a href="popup_content_ncbi_gene_url" target="_blank">popup_content_pcf-gene-id</a></td></tr>
		<tr><th class="popup_content_class">HGNC symbol</th><td><a href="popup_content_hgnc_gene_url" target="_blank">popup_content_hgnc_gene_symbol</a></td></tr>
		<tr><th class="popup_content_class">Synonym</th><td>popup_content_synonym</td></tr>
		<tr><th class="popup_content_class">Full name</th><td>popup_content_full_name</td></tr>
		<tr><th class="popup_content_class">Other full name</th><td>popup_content_other_full_name</td></tr>
		<tr><th class="popup_content_class">Type of gene</th><td>popup_content_type_of_gene</td></tr>
		<tr><th class="popup_content_class">Location</th><td>popup_content_location</td></tr>
		<tr>
			<th class="popup_content_class">Link</th>
			<td>
				<a href="http://www.hgmd.cf.ac.uk/ac/gene.php?gene=popup_content_hgnc_gene_symbol" target="_blank">HGMD</a>
				<a href="https://www.ncbi.nlm.nih.gov/clinvar/?term=popup_content_hgnc_gene_symbol" target="_blank">ClinVar</a>
				<a href="https://togovar.biosciencedbc.jp/?term=popup_content_hgnc_gene_symbol" target="_blank">TogoVar</a>
				<a href="https://www.ncbi.nlm.nih.gov/CBBresearch/Lu/Demo/LitVar/#!?query=popup_content_hgnc_gene_symbol" target="_blank">LitVar</a>
				<a href="https://www.ncbi.nlm.nih.gov/research/pubtator/?view=docsum&query=popup_content_hgnc_gene_symbol" target="_blank">PubTator</a>
				<a href="http://www.dgidb.org/genes/popup_content_hgnc_gene_symbol#_interactions" target="_blank">DGIdb</a>
			</td>
		</tr>
	</table>
</div>

<button onclick="topFunction()" id="btn_back_to_top" title="Go to top">Top</button>

<div class="modal fade" tabindex="-1" role="dialog" id="alert_dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="alertModalLabel">New message</h3>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label for="message-text" class="col-form-label">Server Response:</label>
            <textarea class="form-control" id="alert_response_text" readonly></textarea>
          </div>
          <div class="form-group">
            <label for="message-text" class="col-form-label">URL:</label>
            <textarea class="form-control" id="alert_url" readonly></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="btn_copy_alert_url">Copy URL to clipboard</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" id="alert_dialog_msg">
  <div class="modal-dialog modal-dialog-centered"  role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="alert_dialog_msg_title">Modal title</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="alert_dialog_msg_body">Modal body text goes here.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


</body>

<script type="text/javascript" src="/static/js/pcf/jquery.min.js">

<!-- START: Common footer -->
<script type="text/javascript" src="https://pcf.dbcls.jp/static/common-header-and-footer/script/common-footer.js" id="common-footer__script"></script>
<!-- END: Common footer -->

<script type="text/javascript"
	src="https://dbcls.rois.ac.jp/DBCLS-common-header-footer/v2/script/common-header-and-footer.js"
	style="display: block" id="common-header-and-footer__script" data-width="976" data-color="mono"></script>

<script src="/static/js/pcf/jquery.easing.1.3.js"></script>
<script src="/static/js/pcf/bootstrap-4.6.0.bundle.js"></script>
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>

<script src="/static/js/pcf/jquery.waypoints.min.js"></script>
<script src="/static/js/jquery.countTo.js"></script>
<!-- modify start for chrome 91.0.4472.123-->
<!-- <script src="/static/js/pcf/jquery.magnific-popup.min.js"></script>  -->
<script src="/static/js/pcf/jquery.magnific_popup.min.js"></script>
<!-- modify end for chrome 91.0.4472.123-->
<script src="/static/js/pcf/magnific-popup-options.js"></script>
<script src="/static/js/pcf/jquery.stellar.min.js"></script>
<script src="/static/js/pcf/rater.js"></script>
<script src="/static/js/pcf/main.js"></script>

<script src="/static/js/pcf/jquery.tokeninput.js"></script>
<script src="/static/js/pcf/jquery.tokeninput_gene.js"></script>
<script src="/static/js/d3/3.5.17/d3.min.js"></script>
<script src="/static/js/three.js-r84/build/three.min.js"></script>
<script src="/static/js/three.js-r84/examples/js/Detector.js"></script>
<script src="/static/js/three-bits/OBJLoader.js"></script>
<script src="/static/js/three-bits/three-bits.js"></script>
<script src="/static/js/three-bits/three-bits-renderer.js"></script>
<script src="/static/js/three-bits/defaults.js"></script>
<script type="text/javascript" src="/static/js/pcf/popup-hierarchy-hpo.js"></script>
<script type="text/javascript" src="/static/js/pcf/popup-hierarchy-gene.js"></script>
<script src="/static/js/button-ripple-effect.js"></script>
<script type="text/javascript" src="/static/js/pcf/pcf-content.js"></script>
<script type="text/javascript" src="/static/js/pcf/pcf_collapse_panel.js"></script>

<script>

	var pcf_show_loading = function(){
		if($('#fh5co-loader').css('display') === 'none') $("#fh5co-loader").fadeIn("normal");
		//$('.popover').popover('hide');
		tippy.hideAll();
	};

	var pcf_hide_loading = function() {
		if($('#fh5co-loader').css('display') === 'none') return;
		$("#fh5co-loader").fadeOut("slow");
	};

	$('#btn_search_advanced').on('click', function() {
		$(this).toggleClass('pcf-active');
	});

	$('#btn_cancel').on('click', function (e) {
		$("#search-button_download").dropdown('hide');
		e.preventDefault();
		e.stopPropagation();
		return false;
	});

	$('#btn_download').on('click', function (e) {
		$("#search-button_download").dropdown('hide');
		// do download
		// hpo_id_list
		$("#pcf-content").pcf_content('download',hpo_id_list,$('#sel_download_option').val(), $('#sel_download_format').val());
		e.preventDefault();
		e.stopPropagation();
		return false;
	});

	$('#btn_copy_link')
		.tooltip({'title':'URL Copied to clipboard!', 'trigger':'manual', 'placement':'bottom'})
		.on('click', function (e) {
			$(this).tooltip('show');
			let copyTarget = document.getElementById("share_link");
			copyTarget.select();
			document.execCommand("Copy");
			
			$("#pcf-content").pcf_content('send_share_url', copyTarget.value);
			
			e.preventDefault();
			e.stopPropagation();
			return false;
		})
		.on('mouseleave', function () {
			$(this).tooltip('hide');
		});

	$('#btn_copy_alert_url')
		.tooltip({'title':'URL Copied to clipboard!', 'trigger':'manual', 'placement':'bottom'})
		.on('click', function (e) {
			$(this).tooltip('show');
			let copyTarget = document.getElementById("alert_url");
			copyTarget.select();
			document.execCommand("Copy");
			e.preventDefault();
			e.stopPropagation();
			return false;
		})
		.on('mouseleave', function () {
			$(this).tooltip('hide');
		});

	$('#alert_dialog').on('shown.bs.modal', function () {
		$('#alert_response_text').trigger('focus');
	});

	$('#btn_email_link').on('click', function (e) {
		let copyTarget = document.getElementById("share_link");
		copyTarget.select();
		let link_text = copyTarget.value;

		$("#pcf-content").pcf_content('send_share_url', link_text);

		let mail = 'mailto:?body=' + link_text;
		let a = document.createElement('a');
		a.href = mail;
		a.click();
		
		e.preventDefault();
		e.stopPropagation();
		return false;
	});


	function getDocHeight() {
		var D = document;
		return Math.max(
			D.body.scrollHeight, D.documentElement.scrollHeight,
			D.body.offsetHeight, D.documentElement.offsetHeight,
			D.body.clientHeight, D.documentElement.clientHeight
		);
	}

	var iev=0;
	var ieold = (/MSIE (\d+\.\d+);/.test(navigator.userAgent));
	var trident = !!navigator.userAgent.match(/Trident\/7.0/);
	var rv=navigator.userAgent.indexOf("rv:11.0");

	if (ieold) iev=new Number(RegExp.$1);
	if (navigator.appVersion.indexOf("MSIE 10") != -1) iev=10;
	if (trident&&rv!=-1) iev=11;
	// Firefox or IE 11
	if(typeof InstallTrigger !== 'undefined' || iev == 11) {
		var lastScrollTop = 0;
		$(window).on('scroll', function(e) {

                         if($.magnificPopup.instance.contentContainer && $('.mfp-wrap')) {
                                let $inlineContentBase = $.magnificPopup.instance.contentContainer.find('div.popup-hierarchy-hpo-inline-content-base');
                                if($inlineContentBase){
                                        return;
                                }
                        }

			if(e.target.getAttribute('id') === 'alert_response_text' || e.target.getAttribute('id') === 'alert_url') return;

			st = $(this).scrollTop();
			if(st < lastScrollTop) {
				//console.log('Up');
				//$('header').show();
				//$('header').fadeIn("slow");
				$('header').slideDown(500);
			}
			else if(st > lastScrollTop) {
				//console.log('Down');
				//$('header').hide();
				//$('header').fadeOut("slow");
				if($(window).scrollTop() + $(window).height() < getDocHeight()-50) {
					$('header').slideUp(500);
				}
			}
			lastScrollTop = st;

			//$('.dropdown.show').dropdown('hide');
			$('.dropdown-toggle[aria-expanded="true"]').dropdown('hide');
			tippy.hideAll();

			if (document.body.scrollTop > 110 || document.documentElement.scrollTop > 110) {
				$('#btn_back_to_top').show();
			} else {                        
				$('#btn_back_to_top').hide();  
			}
			
			if($(window).scrollTop() + $(window).height() >= getDocHeight()-50) {
				$('header').slideDown(500);
			}
			
		});
	}
	// Other browsers
	else {
		$('body').on('mousewheel', function(e){

			 if($.magnificPopup.instance.contentContainer && $('.mfp-wrap')) {
	                        let $inlineContentBase = $.magnificPopup.instance.contentContainer.find('div.popup-hierarchy-hpo-inline-content-base');
	                        if($inlineContentBase){
					return;
				}
			}


			if(e.target.getAttribute('id') === 'alert_response_text' || e.target.getAttribute('id') === 'alert_url') return;

			if(e.originalEvent.wheelDelta > 0) {
				//console.log('Up');
				//$('header').show();
				//$('header').fadeIn("slow");
				$('header').slideDown(500);
			}
			else if(e.originalEvent.wheelDelta < 0) {
				//console.log('Down');
				//$('header').hide();
				//$('header').fadeOut("slow");
				if($(window).scrollTop() + $(window).height() < getDocHeight()-50) {
					$('header').slideUp(500);
				}
			}

			//$('.dropdown.show').dropdown('hide');
			$('.dropdown-toggle[aria-expanded="true"]').dropdown('hide');
			tippy.hideAll();

			if (document.body.scrollTop > 110 || document.documentElement.scrollTop > 110) {
				$('#btn_back_to_top').show();
			} else {
				$('#btn_back_to_top').hide();  
			}
			
			if($(window).scrollTop() + $(window).height() >= getDocHeight()-50) {
				$('header').slideDown(500);
			}

			
		});
	}

	function topFunction() {
		$('header').show();
		document.body.scrollTop = 0;
		document.documentElement.scrollTop = 0;
		$('#btn_back_to_top').hide();
	}

	function goDoc(obj){
		window.open(obj.id,'_blank');
	}

	function str_display_format_onchange(display_format) {
                $("#pcf-content").pcf_content('update_display_format', display_format);
                $("#search-button_display").dropdown('hide');
                update_download_link();
                return false;
	}

	function str_size_onchange(size) {
                $("#pcf-content").pcf_content('update_size', parseInt(size));
                $("#search-button_display").dropdown('hide');
                update_download_link();
                return false;
	}

	$("#phenotouch").click(function (e){
		$.PopupRelationHPOWithWebGL();
		e.preventDefault();
		e.stopPropagation();
		return false;
	});

	var update_download_link = function() {
		let target    = $("#pcf-content").pcf_content('get_target');
		let phenotype = hpo_id_list;
		let filter    = $("#tokeninput_genes").tokenInput_gene("get_url_str");
		let size      = $("#str_size").val();
		let format    = $("#str_display_format").val();
		let lang      = $("#r_lang").val();
		
		let url_str = window.location.protocol + "//" + window.location.host + window.location.pathname +
					"?target="+target+"&phenotype="+phenotype+"&filter="+filter+"&size="+size+"&display_format="+format+"&lang="+lang;

		let url_str_en = window.location.protocol + "//" + window.location.host + window.location.pathname +
					"?target="+target+"&phenotype="+phenotype+"&filter="+filter+"&size="+size+"&display_format="+format+"&lang=en";

		let url_str_ja = window.location.protocol + "//" + window.location.host + window.location.pathname +
					"?target="+target+"&phenotype="+phenotype+"&filter="+filter+"&size="+size+"&display_format="+format+"&lang=ja";

		$('#share_link').val(url_str);

		$('#link_en').attr('href',url_str_en);

		$('#link_ja').attr('href',url_str_ja);

		//location.replace(url_str);
	};

	
	var runSubmit = function(){
		// trigger search
		let form = document.createElement("form");
		form.setAttribute("method", "get");
		form.setAttribute("action", "/result");

		let target = document.createElement("input");
		target.setAttribute("type", "text");
		target.setAttribute("name", "target");
		target.setAttribute("value",$("#pcf-content").pcf_content('get_target'));
		form.appendChild(target); 

		let phenotype = document.createElement("input");
		phenotype.setAttribute("type", "text");
		phenotype.setAttribute("name", "phenotype");
		phenotype.setAttribute("value",$("#tokeninput_hpo").val());															   
		form.appendChild(phenotype);

		let filter = document.createElement("input");
		let filter_str = $("#tokeninput_genes").tokenInput_gene("get_url_str");
		filter.setAttribute("type", "text");
		filter.setAttribute("name", "filter");
		filter.setAttribute("value",filter_str);
		

		form.appendChild(filter);  

		let size = document.createElement("input");
		size.setAttribute("type", "text");
		size.setAttribute("name", "size");
		size.setAttribute("value",$("#str_size").val());
		form.appendChild(size);

		let display_format = document.createElement("input");
		display_format.setAttribute("type", "text");
		display_format.setAttribute("name", "display_format");
		display_format.setAttribute("value",$("#str_display_format").val());
		form.appendChild(display_format); 

		let lang = document.createElement("input");
		lang.setAttribute("type", "text");
		lang.setAttribute("name", "lang");
		lang.setAttribute("value",$("#r_lang").val());
		form.appendChild(lang);

		$(form).appendTo('body').submit();

		return false;
	};

	var resizeTimer = false;

	$(window).on('resize', function(e) {

		//$('.dropdown.show').dropdown('toggle');
		$('.dropdown-toggle[aria-expanded="true"]').dropdown('hide');

		$("#tokeninput_genes").tokenInput_gene("resize_input_box");

		if( !resizeTimer ) {
			$(window).trigger('resizestart');  	
		}

		clearTimeout(resizeTimer);
		resizeTimer = setTimeout(function() {
			resizeTimer = false;
			$(window).trigger('resizeend');
		}, 250);
	}).on('resizestart', function(){
	//console.log('Started resizing the window');
	}).on('resizeend', function(){
	//console.log('Done resizing the window');
		customizeLevelPos();
	});


	function modify_modal_on_show(isFullScreen){
		if(isFullScreen){
			$('.mfp-bg').css({'top':'0','opacity':'0.8'});
			$('.mfp-wrap').css({'top':'0'});
			$('header').css({'top': '24px'});
		}else{
			$('header').css({'top': '0'});
			var pos = $("#div_search_button").offset().top;
			$('.mfp-bg').css({'top': pos+'px','opacity':'0'});
			$('.mfp-wrap').css({'top': pos+'px'});
		}
	}

	function after_init_gui(){
		$('#tokeninput_gene_clear').css({'display':'none'});
	}

	function after_modal_close(){
		$('header').css({'top': '24px'});
		$('#tokeninput_gene_clear').css({'display':'block'});
	}


	$('#search-button_download-wrapper').on('shown.bs.dropdown', function () {
		const dropdown = $(this);
		setTimeout(function () {
			dropdown.find('.dropdown-menu').css({
					'top': dropdown.offset().top - $(window).scrollTop() + 8, 
					'left': $('#btn_search_advanced').offset().left - $(window).scrollLeft(), 
					'position': 'fixed'});
		}, 1);
	});

	$('#search-button_share-wrapper').on('shown.bs.dropdown', function () {
		let dropdown = $(this);
		setTimeout(function () {
			dropdown.find('.dropdown-menu').css({
				'top':      dropdown.offset().top - $(window).scrollTop() + 8,
				'left':     $('#btn_search_advanced').offset().left - $(window).scrollLeft(),
				'position': 'fixed'});
		}, 1);
	});

	$('#search-button_display-wrapper').on('shown.bs.dropdown', function () {
		let dropdown = $(this);
		setTimeout(function () {
			dropdown.find('.dropdown-menu').css({
				'top': dropdown.offset().top - $(window).scrollTop() + 8,
				'left': dropdown.offset().left - $(window).scrollLeft(),
				'position': 'fixed'});
		}, 1);
	});


	function customizeLevelPos(){
		if($.magnificPopup.instance.contentContainer && $('.mfp-wrap')){
			let $inlineContentBase = $.magnificPopup.instance.contentContainer.find('div.popup-hierarchy-hpo-inline-content-base');
			if($inlineContentBase){
				let $table = $inlineContentBase.find('div.popup-hierarchy-hpo-table.popup-hierarchy-hpo-class-content-base');
				let popup_hierarchy_hpo_table_border_spacing = 10;
				let $popup_wrapper = $('.mfp-wrap');
				if($popup_wrapper && $popup_wrapper.offset()){
					if($popup_wrapper.offset().top == 0){
						$table.css({'border-spacing': popup_hierarchy_hpo_table_border_spacing+'px','width':'100%','margin-top':'0','margin-left':'0'});
					}else{
						$('header').css({'top': 0});
						$div_search_button = $("#div_search_button");
						var pos = $div_search_button.offset().top +2;
						//var left = $div_search_button.offset().left-popup_hierarchy_hpo_table_border_spacing;
						//var width = $div_search_button.width() + (popup_hierarchy_hpo_table_border_spacing * 2);
						$('.mfp-bg').css({'top': pos+'px','opacity':'0'});
						$('.mfp-wrap').css({'top': pos+'px'});
						$table.css({'width':'100%','margin-left':'0'});
					}
			   } 
			}
		}else{
			$('header').css({'top': '24px'});
		}
	}


	function set_filter_num(){

		let filter_str = $("#tokeninput_genes").tokenInput_gene("get_url_str");

                let count = filter_str.split(',').length;
                if(filter_str && count > 0){
	                $('#btn_search_advanced').html("Filter("+count+")<i class=\"material-icons\">expand_more</i>");
                }else{
                        $('#btn_search_advanced').html("Filter<i class=\"material-icons\">expand_more</i>");
                }
        };

	function onFilterChanged(){
		set_filter_num();
		update_download_link();
		setTimeout(function() {
			let filter_str = $("#tokeninput_genes").tokenInput_gene("get_url_str");
			$("#pcf-content").pcf_content('update_filter', filter_str);
		}, 10);
		return false;
	};

	var hpo_id_list = "{{ r_phenotype }}";
	var filter_id_list = "{{ r_filter }}";
	$(document).ready(function() {

		$("#tokeninput_hpo")
			.tokenInput("/tokeninput_hpo", {theme: "facebook", doSubmit: runSubmit});

		$("#tokeninput_hpo")
			.popupRelationHPO('/popup_hierarchy_hpo',{'modify_modal_on_show':modify_modal_on_show,'after_modal_close':after_modal_close});

		$("#tokeninput_hpo_clear").click(function(){
			$("#tokeninput_hpo").tokenInput("clear");
			return false;
		});
		
		$('#search_button').on('click', function(){
			runSubmit();			
		});		

		$("#tokeninput_genes").tokenInput_gene("/tokeninput_genes", {
			'theme': "facebook",
			{% if r_lang %}
			'language':   "{{ r_lang }}",
			{% endif %}
			'onFilterChanged' : onFilterChanged
		});

		$("#tokeninput_genes")
			.popupRelationGENE('/popup_hierarchy_genes',{'modify_modal_on_show': modify_modal_on_show,
								     'after_modal_close':    after_modal_close,
								     'after_init_gui':       after_init_gui,
								     'onFilterChanged':      onFilterChanged 
								    });

		$("#pcf-content").pcf_content({
			{% if r_target %}
			'target':	"{{ r_target }}",
			{% endif %}
			{% if r_lang %}
			'lang':		"{{ r_lang }}",
			{% endif %}
			{% if r_size %}
			'size':		{{ r_size }},
			{% endif %}
			{% if r_display_format %}
			'format':	"{{ r_display_format }}",
			{% else %}
			'format': 	"summary",
			{% endif %}
			'onSelectTab': function(tab_label_text,target){
				$('#str_target').html(tab_label_text);
				if(target === 'case'){
					$('#btn_download').prop('disabled', true);
				}else{
					$('#btn_download').prop('disabled', false);
				}
				update_download_link();
			}
		});

		if(!filter_id_list){
			$("#token-input-tokeninput_genes").css({'width':'600px'});
		}

		$("#pcf-content").pcf_content('load_phenotype_and_filter_objects_by_ids',hpo_id_list,filter_id_list,function(hpo_obj_list, filter_obj_list){
			let id_list = [];
			hpo_obj_list.forEach(function(item){
				$("#tokeninput_hpo").tokenInput("add", item);
				id_list.push(item.id);
			});
			hpo_id_list = id_list.join(",");

			filter_obj_list.forEach(function(item){
				$("#tokeninput_genes").tokenInput_gene("add", item);
			});
			filter_id_list = $("#tokeninput_genes").tokenInput_gene("get_url_str");

			if(hpo_id_list.length > 0){
				$("#pcf-content").pcf_content('search',{'phenotype':hpo_id_list.replace(/_ja/gi,''),'filter':filter_id_list});
			}else{
				pcf_hide_loading();
			}

			update_download_link();
			set_filter_num();
		});

		 $('[data-toggle="tooltip"]').tooltip({'trigger':'hover'});
	});

</script>

</html>
